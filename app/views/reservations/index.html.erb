<div class="container">
  <p id="notice"><%= notice %></p>

  <h1>Reservations</h1>
  <%#= link_to 'New Order', new_order_path, class: "btn btn-primary", style: 'float: right;margin-bottom: 10px;'%>

  <form action="/reservations">
    <div class="form-group">
      <input type="text" name="query" value="<%= params[:query] %>" class='form-control col-6' placeholder="Search using product or variant id">
    </div>
  </form>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Order Id</th>
        <th>Order Name</th>
        <th>Order qty</th>
        <th>Order Total</th>
        <th>Payment</th>
        <th>Status</th>
        <th>Note</th>
        <th>Created at</th>
        <th>Expiry Date</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <%# count = 0 %>
      <%# date = "" %>
      <% @sorted_orders.each do |order, val| %>
        <% count = val.count + 1 %>
        <% val.each_with_index do |order, index| %>
          <%if order.reserve_status == true %>
          <tr>
            <td><%= count -=  1 %></td>
            <td><%= order.label %></td>
            <td><%= order.order_qty %></td>
            <td><%= order.total %></td>
            <%if order.paidtype.present?%>
              <td><%= order.paidtype %></td>
            <%else%>
              <td></td>
            <%end%>
            <td><%= order.status %></td>
            <%if order.note.present?%>
                <td>
                    <%if order.note.length >= 10%>
                        <%= order.note[0...10]+' . . .'%><input style="height:20px;font-size:10px" type="button" id="open_note" value="See" data-toggle="modal" data-target="#myModal<%=order.id%>">
                    <%else%>
                         <%= order.note %>
                    <%end%>
                </td>
            <%else%>
                <td></td>
            <%end%>
            <!-- Modal -->
            <div class="modal fade" id="myModal<%=order.id%>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
              <div class="modal-dialog" role="document">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLongTitle">Note</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                          </button>
                      </div>
                      <div class="modal-body">
                          <%if order.note.present?%>
                              <%=order.note%>
                          <%end%>
                      </div>
                      <div class="modal-footer">
                          <button type="button"  class="btn btn-secondary" data-dismiss="modal">Close</button>
                          <%# <button class="btn btn-light" id="clickthis" style="color:white"><%= link_to 'Edit Note',edit_reservation_path(order)%></button> 
                      </div>
                  </div>
              </div>
            </div>
      
            
            <td><%= order.created_at.strftime('%d/%m/%Y, %I:%M:%S:%p') %></td>
            <%if order.reservation_expiry_date.present? %>
                <td style=""  ><%= order.reservation_expiry_date.strftime('%d/%m/%Y') %> <%if order.reservation_expiry_date.strftime('%d/%m/%Y').to_date <= Date.today.strftime('%d/%m/%Y').to_date %> <span class="badge badge-danger  blink_me">Deadline</span><%end%></td>
            <%else%>
            <td> </td>
            <%end%>
            <%if order.status == "Processed" %>
                <td><a href="#" id="approve_button" data-toggle="modal" data-target="#approvemodal" onclick="openfun(<%= [order.id,order.paidtype] %>)">Approve</a></td>
                <td>  <%= link_to 'Edit', edit_reservation_path(order)  %></td>
                <%# <%= link_to 'Approve', approvereservation_path(order, order_id: count),id: 'approve_button',data: { confirm: 'Are you sure?' } %> 
            <%else%>
            <td></td>
            <td></td>
            <%end%>
              <td>
                <%= link_to 'Detail', reservation_path(order, order_id: count) %>
              </td>
              <% if current_user.role == "admin" && order.status == "Canceled" %>
                <td>
                  <%= link_to 'Delete', reservation_path(order,:param1 => "reservation"), method: :delete, data: { confirm: 'Are you sure you want to delete order?' } %>
                </td>
              <%else%>
                <td></td>
              <% end %>
                <% if order.status === 'Processed' %>
                  <td>
                    <%= link_to 'Cancel', cancel_order_path(id: order.id, :param1 => "reservation" ), data: { confirm: 'Are you sure you want to cancel order?' } %>
                  </td>
                <% end %>
              </td>
          </tr>
          <%end%>
        <% end %>
      <% end %>
    </tbody>
  </table>
  <form action="/approve_reservation" method="get" id="submit_and_approve"  style="display:none">
  <input class="" value="" id="paidtype_id" name="paidtype" type="text">
  <input class="" value="" id="order_id_" name="order_id" type="text">
  </form>
  <div class="pagination-index">
    <%= will_paginate @orders %>
  </div>
</div>
     <!-- Modal -->
            <div class="modal fade" id="approvemodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
              <div class="modal-dialog" role="document">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLongTitle">Order Payment Type</h5>
                          <button type="button" class="close " data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                          </button>
                      </div>
                      <div class="modal-body">
                        <div style="margin-left:2.5%" class="Row">
                          <div style="float:right;margin-right:34%">
                            <input type="radio" class="check_status" id="check_cash" name="check" value="Cash"  >
                            <label for="payment_cash">Cash</label>
                            <input type="radio" class="check_status" id="check_invoice_cash" name="check" value="Invoice Cash">
                            <label for="payment_invoice_cash">Invoice Cash</label>
                            <input type="radio" class="check_status" id="check_invoice_card" name="check" value="Invoice Card">
                            <label for="payment_invoice_card">Invoice Card</label>
                          </div>
                        </div>                      
                      </div>
                      <div class="modal-footer">
                          <button type="button" id="form_submit"  class="btn btn-secondary " data-dismiss="modal">Approve</button>
                      </div>
                  </div>
              </div>
            </div>

            <script>
            function openfun(order){
              check_status = order[1]
              $("#order_id_")[0].value = order[0]
                if (check_status == "Cash")
                {
                  $("#check_cash").prop("checked",true)
                  $("#paidtype_id")[0].value = "Cash"
                }
                else if (check_status == "Invoice Cash"){
                  $("#check_invoice_cash").prop("checked",true)
                  $("#paidtype_id")[0].value = "Invoice Cash"
                  }
                else if(check_status == "Invoice Card"){
                  $("#check_invoice_card").prop("checked",true)
                  $("#paidtype_id")[0].value = "Invoice Card"
                }

              $('input[type=radio][name=check]').change(function() {
              if($('#check_cash').is(':checked')){
                $("#paidtype_id")[0].value = "Cash"
                console.log("working cash")
              }
              else if ($('#check_invoice_cash').is(':checked')){
                $("#paidtype_id")[0].value = "Invoice Cash"
                console.log("working invpice cash")
              }
              else{
                $("#paidtype_id")[0].value = "Invoice Card"
              }

            })
            }
            $("#form_submit").click(function(e){
              var status= $(".check_status")[0].value
              console.log("submit",status)
              if (status == ""){
                alert("select paidtype")
              }
              else{
                setTimeout(
                function() 
                {
                $("#submit_and_approve").submit()
                }, 100);
              }
            })
            // $("#approve_button").click(function(e){
            //    if (check_status == "Cash")
            //     {
            //       $("#check_cash").prop("checked",true)
            //     }
            //     else if (check_status == "Invoice Cash"){
            //       $("#check_invoice_cash").prop("checked",true)
            //       }
            //     else if(check_status == "Invoice Card"){
            //       $("#check_invoice_card").prop("checked",true)
            //     }
            // })
            //   $('input[type=radio][name=check]').change(function() {
            //   if($('#check_cash').is(':checked')){
            //     $("#paidtype_id")[0].value = "Cash"
            //     console.log("working cash")
            //   }
            //   else if ($('#check_invoice_cash').is(':checked')){
            //     $("#paidtype_id")[0].value = "Invoice Cash"
            //     console.log("working invpice cash")
            //   }
            //   else{
            //     $("#paidtype_id")[0].value = "Invoice Card"
            //   }

            // })
            </script>

<style type="text/css">
  .pagination-index .pagination{
    justify-content: center !important;
  }
  .blink_me {
  animation: blinker 3s step-start infinite;
}

@keyframes blinker {
  50% {
    opacity: 0.3;
  }
}
</style>
